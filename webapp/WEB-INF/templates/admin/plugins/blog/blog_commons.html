<#assign textEditorDefaultName = "fr.paris.lutece.portal.service.editor.RichTextEditorBackOfficeMethod"?new()() >
<#assign textEditorName><#if !dskey('blog.advanced_parameters.editor')?starts_with('DS')>${dskey('blog.advanced_parameters.editor')}<#else>${textEditorDefaultName}</#if></#assign>
<#assign blogEditorFile=.get_optional_template('blog_${textEditorName}.html')>
<#if blogEditorFile.exists>
  <@blogEditorFile.include />
<#else>
  <#assign coreEditorFile=.get_optional_template('/admin/util/editor/editor_${textEditorName}.html')>
  <#if coreEditorFile.exists><@coreEditorFile.include /></#if>
</#if>
<#macro blogJSInit requiredTags=0>
<@initToast id='blogToastContainer' showAll=false >
<@addToast id='blogToast' content='to change' />
</@initToast>
<script src="themes/admin/shared/plugins/blog/js/blog.js"></script>
<script>
var numberOfTagsAssigned = '${blogTagSize}';
var numberMandatoryTags = '${number_mandatory_tags}';

var all_tag = [<#list list_alltag as tag>['${tag.code}','${tag.name?js_string}' ],</#list>];
var blog_tag = [<#list blog.tag as tag>'${tag.idTag}',</#list>];

var msgErrorTagExist = '#i18n{blog.message.errorTagExist}'
var msgErrorTagUpdatePosition = '#i18n{blog.message.errorTagUpdatePosition}' 
var msgErrorTagDeletion = '#i18n{blog.message.errorTagDeletion}' 
var msgErrorTagTitleNotEmpty = '#i18n{blog.message.errorTagTitleNotEmpty}'
var msgErrorTagNotSet = '#i18n{blog.message.message.errorTagNotSet}'

var msgErrorBlogLocked = '#i18n{blog.message.blogLocked}' 
var msgErrorBlogFileCannotBeDeleted = '#i18n{blog.message.blogFileCannotBeDeleted}' 
var msgErrorBlogFileTypeNotUpdated = '#i18n{blog.message.blogFileTypeNotUpdated}' 

var labelWarning='#i18n{portal.util.labelWarning}'
var labelDanger='#i18n{portal.util.labelDanger}'
var labelError='#i18n{portal.util.message.titleError}'

function setBlogToast( toastType, toastTitle, toastContent ){
	const toastBlog = document.querySelector('#blogToast');
  const toastBlogItem = bootstrap.Toast.getOrCreateInstance('#blogToast');
  if( toastType !='' ){ <#noparse>toastBlog.classList.add( `text-bg-warning` );</#noparse> }
	const blogToastBody = document.querySelector( '#blogToast .toast-body' );
  blogToastBody.innerHTML = <#noparse>`<h2>${toastTitle}</h2><p>${toastContent}</p>`</#noparse>
	toastBlogItem.show()
}

document.addEventListener( "DOMContentLoaded", function(){
  const formEditor = document.querySelector('#form-editor'), 
  dLabel=document.querySelector('#div_content_label') , iLabel=document.querySelector('#content_label'),
  dDesc=document.querySelector('#div_description') , iDesc=document.querySelector('#description'),
  dHtml=document.querySelector('#div_html_content') , iHtml=document.querySelector('#html_content');

  refreshMandatoryTagInfo( );

  formEditor.addEventListener( "submit", event => {
    const t = dLabel.textContent.replace('\n','').replace('#i18n{blog.message.default.blogTitle}','').trim();
    if( t == '' ){
      setBlogToast( 'warning' , '#i18n{blog.message.blogTitleNotEmpty}', ''  );
      event.preventDefault();
      dLabel.focus({ focusVisible: true })
      return false;
    } else {
      iLabel.value = t ;
    }
    
    const d = dDesc.innerHTML.replace('#i18n{blog.message.default.blogDescription}','').replace('<p>','').replace('</p>','').trim();
    if( d == '' ) {
      setBlogToast( 'warning' , '#i18n{blog.message.blogDescriptionNotEmpty}', ''  )	
      event.preventDefault();
      dDesc.focus({ focusVisible: true })
      return false;
    } else {
      iDesc.value = d;
    }

    iHtml.value = dHtml.innerHTML.trim();
    
    if( document.querySelector("#tag-list li") != null ){
      const tagsLen = document.querySelector("#tag-list li").length;
      if ( tagsLen == 0  ){
        setBlogToast( 'warning' , '#i18n{blog.message.message.errorTagNotSet}', '' )
        event.preventDefault();
        return false;
      }
    }
  });

  /* Offcanvas  */
  /* Tags       */
  const idBlog = document.querySelector('#id').value;
  const myOffcanvas = document.getElementById('blog-properties')
  myOffcanvas.addEventListener('show.bs.offcanvas', event => {
    const btnAddTag = document.querySelector( "#addTag" )
    btnAddTag.addEventListener( 'click', function(e){
      const tagDoc = document.querySelector('#tag_doc');
      const index = tagDoc.selectedIndex;
      const selOption = tagDoc.options[ index ].textContent;
      doAddTag( tagDoc.value, selOption, idBlog );
    });

    const btnCreateTag = document.querySelector( "#createTag" )
    if (btnCreateTag){
        btnCreateTag.addEventListener( 'click', event => {
            createTag( idBlog );
        });
    }

    const btnAddFiles = document.querySelector("#btn-add-files")
    btnAddFiles.addEventListener( 'click', event => {
      document.querySelector('#attachment').click();
    });
  })
  var number_mandatory_tags=<#if requiredTags gt 0>${requiredTags}<#else>0</#if>

  <@charcounter />
});
</script>

</#macro>
<#function getFileExtension fileName>
<#local lastDotIndex = fileName?last_index_of(".")>
<#if lastDotIndex != -1>
<#return fileName?substring(lastDotIndex + 1) > 
<#else>
<#return x > 
</#if>
</#function>
